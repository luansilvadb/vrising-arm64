# =============================================================================
# GitHub Actions Workflow: Gerar BepInEx Interop para V Rising
# =============================================================================
# Este workflow roda em x86_64 e gera os assemblies de interoperabilidade
# que seriam gerados na primeira inicialização do BepInEx.
# Os arquivos gerados são salvos como artifacts para uso no ARM64.
# =============================================================================

name: Generate BepInEx Interop

on:
  workflow_dispatch:
    inputs:
      game_version:
        description: 'V Rising game version (optional, for naming)'
        required: false
        default: 'latest'
  # Opcionalmente, rodar semanalmente para manter atualizado
  # schedule:
  #   - cron: '0 0 * * 0'  # Domingo à meia-noite

jobs:
  generate-interop:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            lib32gcc-s1 \
            libstdc++6:i386 \
            wine64 \
            wine32 \
            xvfb \
            wget \
            unzip \
            curl
      
      - name: Setup Wine prefix
        run: |
          export WINEPREFIX=$HOME/.wine
          export WINEDLLOVERRIDES="winhttp=n,b;mscoree=d;mshtml=d"
          mkdir -p $WINEPREFIX
          wineboot --init
          # Aguardar Wine inicializar
          sleep 10
          wineserver -k || true
      
      - name: Install SteamCMD
        run: |
          mkdir -p ~/steamcmd
          cd ~/steamcmd
          wget -q "https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz"
          tar -xzf steamcmd_linux.tar.gz
          ./steamcmd.sh +quit || true
      
      - name: Download V Rising Dedicated Server
        run: |
          mkdir -p ~/vrising
          cd ~/steamcmd
          ./steamcmd.sh \
            +@sSteamCmdForcePlatformType windows \
            +force_install_dir ~/vrising \
            +login anonymous \
            +app_update 1829350 validate \
            +quit
      
      - name: Download and setup BepInEx
        run: |
          cd ~/vrising
          
          # Baixar BepInExPack V Rising
          curl -sL "https://thunderstore.io/package/download/BepInEx/BepInExPack_V_Rising/1.733.2/" -o bepinex.zip
          unzip -o bepinex.zip
          
          # Copiar arquivos do BepInExPack
          cp -r BepInExPack_V_Rising/* .
          rm -rf BepInExPack_V_Rising bepinex.zip
          
          # Verificar estrutura
          ls -la
          ls -la BepInEx/
      
      - name: Configure Wine DLL overrides
        run: |
          export WINEPREFIX=$HOME/.wine
          
          # Adicionar DLL override no registro
          cat > /tmp/dll_override.reg << 'EOF'
          REGEDIT4
          
          [HKEY_CURRENT_USER\Software\Wine\DllOverrides]
          "winhttp"="native,builtin"
          "*winhttp"="native,builtin"
          EOF
          
          wine regedit /tmp/dll_override.reg
          wineserver -k || true
      
      - name: Generate BepInEx Interop assemblies
        run: |
          export WINEPREFIX=$HOME/.wine
          export WINEDLLOVERRIDES="winhttp=n,b;mscoree=d;mshtml=d"
          export DISPLAY=:99
          
          cd ~/vrising
          
          # Iniciar display virtual
          Xvfb :99 -screen 0 1024x768x24 &
          sleep 2
          
          echo "Iniciando V Rising Server com BepInEx para gerar interop..."
          echo "Isso pode demorar 5-10 minutos..."
          
          # Rodar o servidor por tempo limitado para gerar interop
          # O servidor vai gerar os assemblies e então podemos parar
          timeout 600 wine VRisingServer.exe \
            -persistentDataPath ./data \
            -logFile ./server.log \
            2>&1 | tee vrising_output.log &
          
          SERVER_PID=$!
          
          # Monitorar até que os assemblies sejam gerados
          for i in {1..60}; do
            echo "Verificando interop... (tentativa $i/60)"
            
            if [ -d "BepInEx/interop" ] && [ "$(ls -A BepInEx/interop 2>/dev/null)" ]; then
              INTEROP_COUNT=$(ls -1 BepInEx/interop/*.dll 2>/dev/null | wc -l)
              echo "Interop gerado! $INTEROP_COUNT assemblies encontrados."
              
              if [ $INTEROP_COUNT -gt 50 ]; then
                echo "Interop completo! Parando servidor..."
                kill $SERVER_PID 2>/dev/null || true
                wineserver -k || true
                break
              fi
            fi
            
            # Verificar se o processo ainda está rodando
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "Servidor parou. Verificando logs..."
              break
            fi
            
            sleep 10
          done
          
          # Mostrar log se houver erro
          if [ -f "server.log" ]; then
            echo "=== Últimas linhas do log ==="
            tail -100 server.log || true
          fi
          
          # Verificar resultado
          if [ -d "BepInEx/interop" ] && [ "$(ls -A BepInEx/interop 2>/dev/null)" ]; then
            echo "✅ Interop gerado com sucesso!"
            ls -la BepInEx/interop/ | head -20
          else
            echo "❌ Falha ao gerar interop"
            exit 1
          fi
      
      - name: Package interop assemblies
        run: |
          cd ~/vrising
          
          # Criar pacote com interop
          mkdir -p interop-package
          
          # Copiar interop
          if [ -d "BepInEx/interop" ]; then
            cp -r BepInEx/interop interop-package/
          fi
          
          # Copiar cache se existir
          if [ -d "BepInEx/cache" ]; then
            cp -r BepInEx/cache interop-package/
          fi
          
          # Adicionar metadata
          echo "Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" > interop-package/metadata.txt
          echo "V Rising Version: ${{ github.event.inputs.game_version }}" >> interop-package/metadata.txt
          echo "BepInEx Version: 1.733.2" >> interop-package/metadata.txt
          
          # Criar arquivo zip
          cd interop-package
          zip -r ../vrising-bepinex-interop.zip .
          
          echo "Pacote criado:"
          ls -la ../vrising-bepinex-interop.zip
      
      - name: Upload interop artifact
        uses: actions/upload-artifact@v4
        with:
          name: vrising-bepinex-interop
          path: ~/vrising/vrising-bepinex-interop.zip
          retention-days: 90
      
      - name: Create Release (if tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ~/vrising/vrising-bepinex-interop.zip
          body: |
            ## V Rising BepInEx Interop Assemblies
            
            Pre-generated interop assemblies for ARM64 compatibility.
            
            - V Rising Version: ${{ github.event.inputs.game_version }}
            - BepInEx Version: 1.733.2
            - Generated: ${{ github.run_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
