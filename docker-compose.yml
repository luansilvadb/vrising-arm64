version: '3.8'

services:
  vrising:
    build: .
    image: vrising-fex:latest
    container_name: vrising-fex
    restart: unless-stopped
    security_opt: [ seccomp:unconfined ]
    cap_add: [ SYS_PTRACE ]
    env_file: .env
    # ports:
    #   - "9876:9876/udp"
    #   - "9877:9877/udp"
    environment:
      - SERVER_NAME=${SERVER_NAME:-V Rising FEX Server}
      - SAVE_NAME=${SAVE_NAME:-world1}
      - SERVER_DESCRIPTION=${SERVER_DESCRIPTION:-}
      - LIST_ON_MASTER_SERVER=${LIST_ON_MASTER_SERVER:-true}
      - GAME_PORT=${GAME_PORT:-9876}
      - QUERY_PORT=${QUERY_PORT:-9877}
      - MAX_CONNECTED_USERS=${MAX_CONNECTED_USERS:-100}
      - MAX_CONNECTED_ADMINS=${MAX_CONNECTED_ADMINS:-5}
      - SERVER_FPS=${SERVER_FPS:-60}
      - SERVER_PASSWORD=${SERVER_PASSWORD:-}
      - SECURE=${SECURE:-true}
      - AUTO_SAVE_COUNT=${AUTO_SAVE_COUNT:-25}
      - AUTO_SAVE_INTERVAL=${AUTO_SAVE_INTERVAL:-120}
      - COMPRESS_SAVE_FILES=${COMPRESS_SAVE_FILES:-true}
      - GAME_SETTINGS_PRESET=${GAME_SETTINGS_PRESET:-}
      - GAME_DIFFICULTY_PRESET=${GAME_DIFFICULTY_PRESET:-}
      - ADMIN_ONLY_DEBUG_EVENTS=${ADMIN_ONLY_DEBUG_EVENTS:-true}
      - DISABLE_DEBUG_EVENTS=${DISABLE_DEBUG_EVENTS:-false}
      - API_ENABLED=${API_ENABLED:-false}
      - RCON_ENABLED=${RCON_ENABLED:-true}
      - RCON_PORT=${RCON_PORT:-25575}
      - RCON_PASSWORD=${RCON_PASSWORD:-}

    volumes:
      - vrising-data:/data

    # --- OTIMIZAÇÕES DE PERFORMANCE ---
    # 1. Modo Host: ATIVADO para máxima performance de rede (menor ping).
    # O container usa a porta 9876 UDP diretamente do servidor.
    network_mode: host

    # A seção 'ports' foi REMOVIDA pois o modo host já expõe todas as portas.
    # ports:
    #   - "9876:9876/udp"
    #   - "9877:9877/udp"

    # 2. Limites do Sistema: Evita engasgos por falta de descritores de arquivo.
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    # 3. Otimizações do Emulador FEX (Avançado)
    # Tenta usar '0' se precisar de mais CPU, mas monitore se o servidor fica instável.
    # environment:
    #   - FEX_TSOENABLE=1

volumes:
  vrising-data:
