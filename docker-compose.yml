services:
  vrising:
    build: .
    image: vrising-arm64
    container_name: vrising-server
    restart: unless-stopped
    
    # Graceful shutdown is critical for save data
    stop_grace_period: 60s
    stop_signal: SIGTERM
    
    ports:
      - "9876:9876/udp"
      - "9877:9877/udp"
      
    environment:
      # Server Configuration
      - SERVER_NAME=MyVServer
      - SAVE_NAME=world1
      # Set to 1 to skip SteamCMD update on startup (faster boot)
      - SKIP_UPDATE=0
      
      # Box64 Performance Optimization (4 cores ARM)
      - BOX64_DYNAREC=1
      - BOX64_DYNAREC_BIGBLOCK=3
      - BOX64_DYNAREC_STRONGMEM=1
      - BOX64_DYNAREC_SAFEFLAGS=0
      - BOX64_DYNAREC_FASTNAN=1
      - BOX64_DYNAREC_FASTROUND=1
      - BOX64_DYNAREC_X87DOUBLE=1
      - BOX64_MAXCPU=4
      - BOX64_LOG=0 # Keep logging low in production
      
      # Box86 Optimization (for SteamCMD)
      - BOX86_DYNAREC=1
      - BOX86_DYNAREC_BIGBLOCK=2
      - BOX86_DYNAREC_STRONGMEM=1
      - BOX86_LOG=0
      
      # Wine Performance
      - WINEDEBUG=-all
      - STAGING_SHARED_MEMORY=1
      
    volumes:
      # Data persistence - init.sh will fix permissions automatically
      - ./server-data:/data
    
    # Resource limits for 4 cores, 25GB RAM
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 24G
        reservations:
          cpus: '2'
          memory: 8G
    
    # Increased shared memory for Wine/Unity
    shm_size: '4gb'
    
    # Performance tuning
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    
    # Reduce logging overhead
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Health check - lighter weight check
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f VRisingServer.exe || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 300s
    
    tty: true
    stdin_open: true

