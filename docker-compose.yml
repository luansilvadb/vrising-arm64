# =============================================================================
# V Rising Dedicated Server - Docker Compose (NTSync Edition)
# =============================================================================
# Este compose tem suporte opcional a NTSync para melhor performance.
#
# Requisitos para NTSync:
# 1. Host com kernel Linux 6.14+ (Ubuntu 25.04+ ou similar)
# 2. Módulo ntsync carregado: sudo modprobe ntsync
# 3. Descomentar a seção "devices" abaixo
#
# Sem NTSync, o servidor funciona normalmente com performance padrão.
# =============================================================================

services:
  vrising:
    build:
      context: .
      # Para usar versão com NTSync, mude para:
      # dockerfile: Dockerfile.ntsync
      dockerfile: Dockerfile
    container_name: vrising-server
    restart: unless-stopped

    # Variáveis de ambiente para configuração
    environment:
      # Configurações básicas do servidor
      - SERVER_NAME=${SERVER_NAME:-Velion}
      - SERVER_DESCRIPTION=${SERVER_DESCRIPTION:-Servidor dedicado brasileiro - Bem-vindo ao Velion!}
      - WORLD_NAME=${WORLD_NAME:-world1}
      - PASSWORD=${PASSWORD:-}
      - MAX_USERS=${MAX_USERS:-100}

      # Portas do jogo
      - GAME_PORT=${GAME_PORT:-9876}
      - QUERY_PORT=${QUERY_PORT:-9877}

      # Visibilidade do servidor (true = aparece na lista pública)
      - LIST_ON_MASTER_SERVER=${LIST_ON_MASTER_SERVER:-true}
      - LIST_ON_EOS=${LIST_ON_EOS:-true}

      # Modo de jogo
      - GAME_MODE_TYPE=${GAME_MODE_TYPE:-PvP}

      # Preset de dificuldade (Difficulty_Easy, Difficulty_Normal, Difficulty_Brutal)
      - GAME_DIFFICULTY_PRESET=${GAME_DIFFICULTY_PRESET:-Difficulty_Brutal}

      # FPS do servidor (30 = menos CPU, 60 = mais fluido)
      - SERVER_FPS=${SERVER_FPS:-60}

      # Atualização automática no restart
      - AUTO_UPDATE=${AUTO_UPDATE:-true}

      # RCON (acesso admin remoto)
      - RCON_ENABLED=${RCON_ENABLED:-true}
      - RCON_PORT=${RCON_PORT:-25575}
      - RCON_PASSWORD=${RCON_PASSWORD:-}

      # Timezone
      - TZ=${TZ:-America/Sao_Paulo}

    # Portas expostas (UDP para jogo, TCP para RCON)
    ports:
      - "${GAME_PORT:-9876}:${GAME_PORT:-9876}/udp"
      - "${QUERY_PORT:-9877}:${QUERY_PORT:-9877}/udp"
      - "${RCON_PORT:-25575}:${RCON_PORT:-25575}/tcp"

    # Volumes para persistência de dados
    volumes:
      # Volume único para todos os dados (server, saves, wine, logs)
      - vrising-data:/data

    # =========================================================================
    # NTSYNC SUPPORT (Habilitado)
    # =========================================================================
    # NTSync melhora performance em +50-100% quando disponível.
    #
    # Requisitos no HOST:
    # 1. Kernel Linux 6.14+ (Ubuntu 25.04+, Fedora 42+, etc)
    # 2. Módulo ntsync carregado:
    #    - Temporário: sudo modprobe ntsync
    #    - Permanente: echo "ntsync" | sudo tee /etc/modules-load.d/ntsync.conf
    # 3. Device /dev/ntsync deve existir
    #
    # ⚠️ Se o host NÃO tiver NTSync, comente as linhas abaixo ou o container falhará
    # =========================================================================
    devices:
      - /dev/ntsync:/dev/ntsync

    # Recursos (ajuste conforme necessário)
    # EasyPanel gerencia isso automaticamente, mas você pode definir limites
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G

    # Healthcheck
    healthcheck:
      test: [ "CMD", "nc", "-zu", "localhost", "${GAME_PORT:-9876}" ]
      interval: 60s
      timeout: 10s
      start_period: 900s
      retries: 3

    # Grace period para shutdown limpo (autosave)
    stop_grace_period: 30s

    # Network mode bridge para compatibilidade
    network_mode: bridge

# Volumes nomeados para persistência
volumes:
  vrising-data:
    driver: local
