services:
  vrising:
    build: .
    image: vrising-arm64
    container_name: vrising-server
    restart: unless-stopped
    
    # Graceful shutdown is critical for save data
    stop_grace_period: 60s
    stop_signal: SIGTERM
    
    # Security hardening for production
    # NOTE: Temporarily using privileged for debugging Steam network issue
    # After confirming it works, we'll reduce to minimal required capabilities
    privileged: true
    # security_opt:
    #   - no-new-privileges:true
    # cap_drop:
    #   - ALL
    # cap_add:
    #   - NET_RAW        # Required for Steam UDP sockets
    #   - NET_BIND_SERVICE  # Bind to ports < 1024 if needed
    #   - SYS_ADMIN      # May be needed for Wine/Steam
    
    # Use host networking for Steam compatibility
    # Steam's SteamNetworking requires direct access to network interfaces
    # Without this, GetAdaptersAddresses fails and server crashes
    network_mode: host
    
    # Note: With network_mode: host, ports mapping is not needed
    # The server will bind directly to host ports 9876/udp and 9877/udp
      
    environment:
      # Server Configuration
      - SERVER_NAME=MyVServer
      - SAVE_NAME=world1
      # Set to 1 to skip SteamCMD update on startup (faster boot)
      - SKIP_UPDATE=0
      
      # Box64 Performance Optimization (4 cores ARM)
      # PRODUCTION STABLE SETTINGS - prioritize stability for long-running servers
      - BOX64_DYNAREC=1
      - BOX64_DYNAREC_BIGBLOCK=0       # Critical for Unity games with JIT/multithreading
      - BOX64_DYNAREC_STRONGMEM=2      # Stricter memory ordering (prevents race conditions)
      - BOX64_DYNAREC_SAFEFLAGS=1      # Safer x86 flag handling (prevents subtle crashes)
      - BOX64_DYNAREC_FASTNAN=1
      - BOX64_DYNAREC_FASTROUND=1
      - BOX64_DYNAREC_X87DOUBLE=1
      - BOX64_DYNAREC_CALLRET=1        # Optimize CALL/RET instructions
      - BOX64_DYNACACHE=1              # Enable dynarec cache for better performance
      - BOX64_MAXCPU=4
      - BOX64_LOG=0                    # Keep logging low in production
      
      # Box86 Optimization (for SteamCMD)
      - BOX86_DYNAREC=1
      - BOX86_DYNAREC_BIGBLOCK=2
      - BOX86_DYNAREC_STRONGMEM=1
      - BOX86_LOG=0
      
      # Wine Performance
      - WINEDEBUG=-all
      - STAGING_SHARED_MEMORY=1
      
    volumes:
      # Data persistence - init.sh will fix permissions automatically
      - ./server-data:/data
    
    # Resource limits for 4 cores, 25GB RAM
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 24G
        reservations:
          cpus: '2'
          memory: 8G
    
    # Increased shared memory for Wine/Unity
    shm_size: '4gb'
    
    # Performance tuning
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    
    # Reduce logging overhead
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Health check - verify process AND port is listening
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f VRisingServer.exe && ss -uln | grep -q ':9876' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 300s
    
    tty: true
    stdin_open: true

