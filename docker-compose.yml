# =============================================================================
# V Rising Dedicated Server - Docker Compose (NTSync Edition)
# =============================================================================
# NTSync AUTOMÁTICO via privileged mode.
#
# O container detecta automaticamente se o host tem NTSync disponível.
# Se tiver: +50-100% FPS | Se não tiver: funciona normalmente
#
# Único requisito no HOST (se quiser NTSync):
#   sudo modprobe ntsync
#   echo "ntsync" | sudo tee /etc/modules-load.d/ntsync.conf
# =============================================================================

services:
  vrising:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vrising-server
    restart: unless-stopped

    # Modo privilegiado para acesso automático a /dev/ntsync
    # Isso permite NTSync funcionar automaticamente se disponível no host
    privileged: true

    # NTSync device mapping - HABILITADO (verificado no host: /dev/ntsync existe)
    # Para verificar no host: ls -la /dev/ntsync
    # Se der erro no docker compose, comente estas linhas
    devices:
      - /dev/ntsync:/dev/ntsync

    # Variáveis de ambiente para configuração
    environment:
      # Configurações básicas do servidor
      - SERVER_NAME=${SERVER_NAME:-Velion}
      - SERVER_DESCRIPTION=${SERVER_DESCRIPTION:-Servidor dedicado brasileiro - Bem-vindo ao Velion!}
      - WORLD_NAME=${WORLD_NAME:-world1}
      - PASSWORD=${PASSWORD:-}
      - MAX_USERS=${MAX_USERS:-100}

      # Portas do jogo
      - GAME_PORT=${GAME_PORT:-9876}
      - QUERY_PORT=${QUERY_PORT:-9877}

      # Visibilidade do servidor (true = aparece na lista pública)
      - LIST_ON_MASTER_SERVER=${LIST_ON_MASTER_SERVER:-true}
      - LIST_ON_EOS=${LIST_ON_EOS:-true}

      # Modo de jogo
      - GAME_MODE_TYPE=${GAME_MODE_TYPE:-PvP}

      # Preset de dificuldade (Difficulty_Easy, Difficulty_Normal, Difficulty_Brutal)
      - GAME_DIFFICULTY_PRESET=${GAME_DIFFICULTY_PRESET:-Difficulty_Brutal}

      # FPS do servidor (30 = menos CPU, 60 = mais fluido)
      - SERVER_FPS=${SERVER_FPS:-60}

      # Atualização automática no restart
      - AUTO_UPDATE=${AUTO_UPDATE:-true}

      # BepInEx/Plugins (true = habilita mods)
      - ENABLE_PLUGINS=${ENABLE_PLUGINS:-false}

      # RCON (acesso admin remoto)
      - RCON_ENABLED=${RCON_ENABLED:-true}
      - RCON_PORT=${RCON_PORT:-25575}
      - RCON_PASSWORD=${RCON_PASSWORD:-}

      # Timezone
      - TZ=${TZ:-America/Sao_Paulo}

    # Portas expostas (UDP para jogo, TCP para RCON)
    ports:
      - "${GAME_PORT:-9876}:${GAME_PORT:-9876}/udp"
      - "${QUERY_PORT:-9877}:${QUERY_PORT:-9877}/udp"
      - "${RCON_PORT:-25575}:${RCON_PORT:-25575}/tcp"

    # Volumes para persistência de dados
    volumes:
      # Volume único para todos os dados (server, saves, wine, logs)
      - vrising-data:/data

    # =========================================================================
    # NTSYNC SUPPORT (Automático via privileged mode)
    # =========================================================================
    # Com privileged: true, o container tem acesso automático a /dev/ntsync
    # se estiver disponível no host. Não precisa configurar nada!
    #
    # Requisitos no HOST:
    # 1. Kernel Linux 6.14+ (Ubuntu 25.04+)
    # 2. Módulo ntsync carregado:
    #    sudo modprobe ntsync
    #    echo "ntsync" | sudo tee /etc/modules-load.d/ntsync.conf
    #
    # O entrypoint.sh detecta automaticamente se NTSync está disponível.
    # =========================================================================

    # Recursos (ajuste conforme necessário)
    # EasyPanel gerencia isso automaticamente, mas você pode definir limites
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G

    # Healthcheck
    healthcheck:
      test: [ "CMD", "nc", "-zu", "localhost", "${GAME_PORT:-9876}" ]
      interval: 60s
      timeout: 10s
      start_period: 900s
      retries: 3

    # Grace period para shutdown limpo (autosave)
    stop_grace_period: 30s

    # Network mode bridge para compatibilidade
    network_mode: bridge

# Volumes nomeados para persistência
volumes:
  vrising-data:
    driver: local
